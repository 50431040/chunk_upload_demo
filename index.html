<!DOCTYPE html>
<html lang="en" style="height: 100%;">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>切片上传</title>
</head>

<style>
    body {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    #progress {
        margin-top: 10px;
    }
    #btn {
        width: 60px;
        height: 30px;
        background-color: white;
        color: black;
        border: 2px solid #eee;
        margin-left: 20px;
    }

    #btn:hover {
        background-color: #ddd;
    }
</style>

<body>
    <div>
        请选择文件：
        <input type="file" id="upload">
    </div>
    <div id="progress">
        当前进度：<span id="progressText">0</span>%
        <button id="btn">暂停</button>
    </div>

    <!-- axios -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.27.2/axios.js"></script>

    <script>
        const url = "http://localhost:8080"

        // 切片
        function generateChunkList(file) {
            const list = []
            // 分割大小：1M
            const size = 1024 * 1024
            let cur = 0

            while (cur < file.size) {
                list.push({
                    chunk: file.slice(cur, cur + size),
                    hash: cur
                })
                cur += size
            }

            return list
        }

        // 上传
        function upload(data, filename, size) {
            return new Promise((resolve, reject) => {
                const {
                    chunk,
                    hash
                } = data

                const formData = new FormData()
                formData.append("chunk", chunk)
                formData.append("hash", hash)
                formData.append("filename", filename)
                formData.append("size", size)

                axios({
                    method: "POST",
                    url,
                    data: formData
                }).then(resolve).catch(reject)
            })
        }

        function partUpload(chunks, filename, size, max = 5) {

            // 执行序号
            let execIndex = 0
            // 完成数量
            let completeCount = 0

            const progressTextDom = document.getElementById("progressText")

            const loop = (index) => {
                upload(chunks[index], filename, size).then(() => {

                    completeCount++
                    // 更新进度
                    progressTextDom.innerText = Math.floor(completeCount / chunks.length * 100).toString()
                    
                    if (completeCount === chunks.length) {
                        console.log('所有chunk上传完成')
                        return
                    }

                    if (execIndex < chunks.length) {
                        loop(execIndex++)
                    }
                    
                }).catch((err) => {
                    console.log("上传失败", err)
                })
            }
            
            for (; execIndex < max && execIndex < chunks.length; execIndex++) {
                loop(execIndex)
            }
        }

        document.getElementById("upload").addEventListener("change", function () {
            const files = this.files
            const file = files[0]

            if (!file) {
                return
            }

            const chunks = generateChunkList(file)
            const filename = `${new Date().getTime()}_${file.name}`

            document.getElementById("progressText").innerText = "0"

            partUpload(chunks, filename, file.size)
        })
    </script>
</body>

</html>